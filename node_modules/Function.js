var HTTPQuery = require("HTTPQuery.js")
var SolArray = require("Array.js")
var Transaction = require("Transaction.js")

module.exports = Function;

function Function(toContract, api) { // NOT the solc API
    // argObj = {
    //   fromAccount:, value:, gasPrice, gasLimit
    // }
    function f(apiURL, callback, argObj) {
        var args = [];
        for (var i = 3; i < arguments.length; ++i) {
            args.push(arguments[i]);
        }
        argObj.toAccount = toContract;
        argObj.data = api.functionHash + SolArray(args).encoding();

        Transaction(argObj).send(
            apiURL, getResultAndCallback.bind(this, apiURL, callback));
    }
    f.domain = api.functionDomain;
    f.returns = api.functionReturns;
    f.argNames = api.functionArgs;
    f.toString = function() { return api["solidityType"]; };
    f.encoding = function() { return argObj.functionHash; };
    return f;
}

function getResultAndCallback(apiURL, callback, tx) {
    HTTPQuery.queryAPI(apiURL + "/transactionResult/" + tx.hash,
                       useRetVal.bind(this, callback));
}

function useRetVal(callback, txResultJSON) {
    var txResult = JSON.parse(txResultJSON);
    var retVal = txResult.response; // needs to be decoded
    if (typeof callback === "function") {
        callback(retVal);
    }
}
