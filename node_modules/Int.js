module.exports = Int;
module.exports.exp2 = function(n) { return Int(Int(1).shiftLeft(n)); }

function Int(x) {
    var bigInt = require("big-integer");
    var y;
    if (typeof x === "string" && x.slice(0,2) === "0x") {
        y = bigInt(x.slice(2),16);
    }
    else if (Buffer.isBuffer(x)) {
        y = bigInt(x.toString("hex"),16);
    }
    else {
        y = bigInt(x);
    }

    var constr = pickConstructor(y);
    return new constr(y);
}

function pickConstructor(y) {
    var bigInt = require("big-integer");
    var smallInt = bigInt(0);
    var smallIntProto = Object.getPrototypeOf(smallInt);
    var SmallInteger = smallIntProto.constructor;

    function SmallInt(smallbigInt) {
        SmallInteger.call(this, smallbigInt.value);
    }

    SmallInt.prototype = prototypeInt(smallIntProto, SmallInt);

    var bigInt = bigInt(1).shiftLeft(256);
    var bigIntProto = Object.getPrototypeOf(bigInt);
    var bigInteger = bigIntProto.constructor;

    function BigInt(bigbigInt) {
        bigInteger.call(this, bigbigInt.value, bigbigInt.sign);
    }

    BigInt.prototype = prototypeInt(bigIntProto, BigInt);

    if (y.isSmall) {
        return SmallInt;
    }
    else {
        return BigInt;
    }
}

function prototypeInt (baseProto, constr) {
    return Object.create(baseProto, { 
        encoding : {
            enumerable : true,
            value : encodingInt
        },
        toString : {
            enumerable : true,
            value : function () { return baseProto.toString.call(this,10); }
        },
        toJSON : {
            enumerable : true,
            value : function () {
                if (this.isSmall) {
                    return this.valueOf();
                }
                else {
                    return this.toString();
                }
            }
        },
        isFixed : {
            enumerable : true,
            value : true
        },
        constructor : {
            value : constr,
            enumerable : false
        }
    });
};

function encodingInt() {
    var bigInt = require("big-integer");
    var result;
    if (this.geq(0)) {
        bigIntProto = Object.getPrototypeOf(Object.getPrototypeOf(this));
        result = bigIntProto.toString.call(this,16);
        if (result.length % 2 != 0) {
            result = "0" + result;
        }
        while (result.length < 64) {
            result = "00" + result;
        }
    }
    else {
        result = Int(this.plus(Int.exp2(256))).encoding();
    }
    return result;
}
